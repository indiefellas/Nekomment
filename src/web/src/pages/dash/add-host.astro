---
import AddDomainForm from "../../components/forms/AddDomainForm.svelte";
import MainLayout from "../../layouts/MainLayout.astro";
export const prerender = false;
const { env } = Astro.locals.runtime;

let token = Astro.cookies.get("host-token")?.value;
if (!token) {
    token = await env.NEKOMMENT_API.initializeAddHostToken(
        Astro.cookies.get("token")?.value || "",
    ).data;
    Astro.cookies.set("host-token", token || "");
}

let err = "";
if (Astro.request.method === "POST") {
    try {
        const data = await Astro.request.formData();
        const domain = data.get("domain")?.toString() || "";
        const method = data.get("method")?.toString() || "";
        let session = await env.NEKOMMENT_API.addHost(
            Astro.cookies.get("token")?.value || "",
            token || '',
            domain,
            method,
        );
        Astro.cookies.delete("host-token");
        if (session.success) {
            return Astro.redirect("/dash/" + domain, 302);
        } else {
            err = "An error occurred. Please try again. " + session.message;
        }
    } catch {
        err = "An error occurred. Please try again.";
    }
}
---

<MainLayout>
    <AddDomainForm verificationToken={token} client:load />
</MainLayout>
